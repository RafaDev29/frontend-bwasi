"use strict";(self["webpackChunkfrontend_ebox_platform"]=self["webpackChunkfrontend_ebox_platform"]||[]).push([[643],{15:function(e,t,o){o.d(t,{B:function(){return a}});o(4114),o(1454);function n(e){return{all:e=e||new Map,on:function(t,o){var n=e.get(t);n?n.push(o):e.set(t,[o])},off:function(t,o){var n=e.get(t);n&&(o?n.splice(n.indexOf(o)>>>0,1):e.set(t,[]))},emit:function(t,o){var n=e.get(t);n&&n.slice().map((function(e){e(o)})),(n=e.get("*"))&&n.slice().map((function(e){e(t,o)}))}}}const a=n()},2757:function(e,t,o){o.r(t),o.d(t,{default:function(){return ge}});var n=o(6768),a=o(5130),l=o(4232),r=o(1161);const i={class:"flex flex-col justify-center items-center relative"},s={class:"w-full flex justify-center mb-4 relative"},c={class:"relative w-1/3"},u={key:0,class:"absolute left-0 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-2 z-10"},d=["onClick"],g={class:"font-semibold text-gray-800"},f={class:"text-gray-500 text-sm block"},h={class:"text-gray-400 text-sm italic"},p={class:"flex items-center justify-center bg-gray-100 mb-5 pb-5 w-full"},m={class:"fixed top-1/2 right-5 transform -translate-y-1/2 flex flex-col items-center space-y-4"},v=["onClick"];function y(e,t,o,y,b,k){const x=(0,n.g2)("ModalLayoutPlane");return(0,n.uX)(),(0,n.CE)("div",i,[(0,n.Lk)("div",s,[(0,n.Lk)("div",c,[t[2]||(t[2]=(0,n.Lk)("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[(0,n.Lk)("svg",{class:"h-5 w-5 text-gray-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,n.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-4.35-4.35m2.1-6.65a7.5 7.5 0 11-15 0 7.5 7.5 0 0115 0z"})])],-1)),(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>y.searchQuery=e),onInput:t[1]||(t[1]=(...e)=>y.updateSearchResults&&y.updateSearchResults(...e)),type:"text",placeholder:"Buscar",class:"w-full border border-gray-300 rounded-lg px-10 py-2 text-gray-700 focus:ring-2 focus:ring-[#497fae] focus:border-[#497fae] shadow-sm"},null,544),[[a.Jo,y.searchQuery]]),y.searchResults.length>0&&y.searchQuery.length>0?((0,n.uX)(),(0,n.CE)("ul",u,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(y.searchResults,(e=>((0,n.uX)(),(0,n.CE)("li",{key:e.id,onClick:t=>y.selectBeaconFromSearch(e.id),class:"px-4 py-2 hover:bg-[#497fae] cursor-pointer flex justify-between items-center"},[(0,n.Lk)("div",null,[(0,n.Lk)("span",g,(0,l.v_)(e.name),1),(0,n.Lk)("span",f,"("+(0,l.v_)(e.identifier)+")",1)]),(0,n.Lk)("span",h,(0,l.v_)(e.areaName),1)],8,d)))),128))])):(0,n.Q3)("",!0)])]),(0,n.Lk)("div",p,[y.selectedLayout?((0,n.uX)(),(0,n.Wv)(x,{key:y.selectedLayout._id,name:y.selectedLayout.name,backgroundimage:y.selectedLayout.backgroundImage,areas:y.selectedLayout.areas,highlightedBeacon:y.highlightedBeacon,onHighlight:y.highlightBeacon},null,8,["name","backgroundimage","areas","highlightedBeacon","onHighlight"])):(0,n.Q3)("",!0)]),(0,n.Lk)("div",m,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(y.layouts,((e,t)=>((0,n.uX)(),(0,n.Wv)(r.y,{key:e._id,text:e.name},{activator:(0,n.k6)((({props:e})=>[(0,n.Lk)("div",(0,n.v6)({ref_for:!0},e,{class:["w-10 h-10 rounded-full cursor-pointer flex items-center justify-center transition-transform duration-300",{"bg-[#6999c2] text-white transform scale-110 shadow-lg":t===y.selectedIndex,"bg-[#bfd3e6] text-gray-700 hover:bg-[#6999c2]":t!==y.selectedIndex}],onClick:e=>y.selectLayout(t)}),(0,l.v_)(t+1),17,v)])),_:2},1032,["text"])))),128))])])}o(8992),o(4520),o(2577),o(670),o(1454);var b=o(144),k=o(1189),x=o(1714);const w="https://api.bwasi.maquiadev.com/api/v1";function C(e){return k.A.get(`${w}/monitoring`,{headers:{Authorization:`Bearer ${e}`}})}let L=null;function I(e,t,o){const n="https://api.bwasi.maquiadev.com";L=(0,x.io)(n,{extraHeaders:{auth:o}}),L.on("connect",(()=>{console.log("Conexión establecida con el servidor de Socket.IO")})),L.on("monitoringUpdate",(t=>{console.log("Evento monitoringUpdate recibido:",t),e&&e(t)})),L.on("connect_error",(e=>{console.error("Error de conexión Socket.IO:",e),t&&t(e)})),L.on("disconnect",(()=>{console.log("Conexión Socket.IO cerrada.")}))}function B(){L&&(L.disconnect(),L=null)}const _={class:"relative flex flex-col items-center"},A={class:"text-gray-700 font-bold text-lg mb-2 relative w-full"},M={class:"relative border border-gray-300 rounded-lg shadow-md"},E={class:"absolute top-0 left-0 w-full h-full pointer-events-none"};function X(e,t,o,a,r,i){const s=(0,n.g2)("v-image"),c=(0,n.g2)("v-shape"),u=(0,n.g2)("v-text"),d=(0,n.g2)("v-layer"),g=(0,n.g2)("v-stage"),f=(0,n.g2)("MonitoringBeacon"),h=(0,n.g2)("MonitoringLayout");return(0,n.uX)(),(0,n.CE)(n.FK,null,[(0,n.Lk)("div",_,[(0,n.Lk)("h1",A,(0,l.v_)(o.name),1),(0,n.Lk)("div",M,[(0,n.bF)(g,{ref:"stage",config:a.stageConfig,onContentClick:e.onStageClick},{default:(0,n.k6)((()=>[(0,n.bF)(d,null,{default:(0,n.k6)((()=>[o.backgroundimage?((0,n.uX)(),(0,n.Wv)(s,{key:0,config:{image:a.backgroundImg,width:a.stageConfig.width,height:a.stageConfig.height}},null,8,["config"])):(0,n.Q3)("",!0),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.areas,(e=>((0,n.uX)(),(0,n.CE)(n.FK,{key:e._id},[(0,n.bF)(c,{config:{sceneFunc:(t,o)=>{const n=a.parseCoordinates(e.coordinates);if(t.beginPath(),n.length>0){t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)t.lineTo(n[e].x,n[e].y);t.closePath()}t.fillStrokeShape(o)},fill:a.getAreaColor(e),stroke:a.countBeaconsForAforo(e.items,e.aforo.typeItemMobiles)>e.aforo.amount?"red":"",strokeWidth:a.countBeaconsForAforo(e.items,e.aforo.typeItemMobiles)>e.aforo.amount?4:2}},null,8,["config"]),(0,n.bF)(u,{config:{text:`${e.name}\n(${a.countBeaconsForAforo(e.items,e.aforo.typeItemMobiles)}/${e.aforo.amount})\nTotal: ${e.items.length}`,x:a.calculateAreaCenter(a.parseCoordinates(e.coordinates)).x,y:a.calculateAreaCenter(a.parseCoordinates(e.coordinates)).y,fontSize:16,fontFamily:"Arial",fill:"black",align:"center",verticalAlign:"middle",cursor:"pointer"},onMouseover:a.onTextHover,onMouseout:a.onTextOut,onClick:t=>a.onAreaNameClick(e),style:{cursor:"pointer"}},null,8,["config","onMouseover","onMouseout","onClick"])],64)))),128))])),_:1})])),_:1},8,["config","onContentClick"]),(0,n.Lk)("div",E,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.areas,(l=>((0,n.uX)(),(0,n.CE)("div",{key:l._id,class:"flex flex-wrap"},[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(a.reduceBeaconsByTypeId(l.items),((r,i)=>((0,n.uX)(),(0,n.Wv)(f,{key:r._id,beacon:r,position:a.getBeaconPosition(r,l,i,l.items.length),isHighlighted:o.highlightedBeacon&&a.findBeaconAndAreaById(o.highlightedBeacon)?.area._id===l._id&&r.typeId===a.findBeaconAndAreaById(o.highlightedBeacon)?.beacon.typeId,onHighlight:t[0]||(t[0]=t=>e.$emit("highlight",t)),class:"pointer-events-auto"},null,8,["beacon","position","isHighlighted"])))),128))])))),128))])])]),(0,n.bF)(h)],64)}o(8872);var F=o(15);const K={class:"relative"},j={key:0,class:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-2 py-1 bg-black text-white text-xs rounded whitespace-nowrap z-50"};function S(e,t,o,a,r,i){return o.position?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"absolute flex flex-col items-center cursor-pointer",style:(0,l.Tr)({top:`${o.position.y}px`,left:`${o.position.x}px`,transform:"translate(-50%, -50%)"})},[(0,n.Lk)("div",K,[(0,n.Lk)("div",{class:(0,l.C4)(["w-6 h-6 rounded-full shadow-md flex items-center justify-center",{highlighted:o.isHighlighted}]),style:(0,l.Tr)({backgroundColor:o.isHighlighted?"yellow":o.beacon.backgroundColor||"white",border:`1px solid ${o.beacon.color||"#000000"}`}),onMouseover:t[0]||(t[0]=e=>r.showTooltip=!0),onMouseleave:t[1]||(t[1]=e=>r.showTooltip=!1)},[(0,n.Lk)("i",{class:(0,l.C4)(o.beacon.icon),style:(0,l.Tr)({color:o.beacon.color,fontSize:o.beacon.size||"14px"})},null,6)],38),r.showTooltip?((0,n.uX)(),(0,n.CE)("div",j,(0,l.v_)(o.beacon.typeName)+" ("+(0,l.v_)(o.beacon.groupCount||1)+") ",1)):(0,n.Q3)("",!0)])],4)):(0,n.Q3)("",!0)}var T={props:{beacon:{type:Object,required:!0},position:{type:Object,required:!0},isHighlighted:{type:Boolean,default:!1}},watch:{isHighlighted(e){e&&console.log(`Beacon with ID ${this.beacon._id} received highlight event.`)}},data(){return{showTooltip:!1}}},R=o(1241);const N=(0,R.A)(T,[["render",S],["__scopeId","data-v-3c75fa9a"]]);var O=N;const Q={key:0,class:"fixed top-0 right-0 w-1/4 h-full bg-white text-gray-800 shadow-lg p-6 overflow-y-auto bg-opacity-50 z-[9999]"},H={class:"flex items-center justify-between mb-6"},W={class:"text-xl font-bold flex items-center"},$={class:"flex items-center text-sm bg-gray-100 p-2 rounded-lg shadow-md"},V={class:"text-gray-700"},P={class:"mb-6"},q={key:0,class:"space-y-6"},z={class:"space-y-6"},U={class:"font-semibold text-[#1cb0c8] mb-4"},D={class:"grid grid-cols-1 sm:grid-cols-2 gap-1"},G={class:"text-sm text-gray-700"},J={key:0,class:"text-right mt-4"},Y=["onClick"],Z={key:1,class:"text-right mt-4"},ee=["onClick"],te={key:1,class:"text-center text-gray-500"};function oe(e,t,o,r,i,s){return(0,n.uX)(),(0,n.Wv)(a.eB,{name:"slide"},{default:(0,n.k6)((()=>[r.isOpen?((0,n.uX)(),(0,n.CE)("div",Q,[(0,n.Lk)("button",{class:"relative justify-end text-[#1c9ccc] hover:text-[#1cb0c8]",onClick:t[0]||(t[0]=(...e)=>r.closePanel&&r.closePanel(...e))},t[2]||(t[2]=[(0,n.Lk)("i",{class:"mdi mdi-arrow-right-bold-circle text-3xl"},null,-1)])),(0,n.Lk)("div",H,[(0,n.Lk)("h2",W,[t[3]||(t[3]=(0,n.Lk)("span",{class:"mdi mdi-map-marker text-2xl mr-2"},null,-1)),(0,n.eW)(" "+(0,l.v_)(r.area.name),1)]),(0,n.Lk)("div",$,[t[4]||(t[4]=(0,n.Lk)("span",{class:"mdi mdi-account-group text-blue-600 mr-0"},null,-1)),t[5]||(t[5]=(0,n.Lk)("p",{class:"font-semibold mr-1"},"Aforo:",-1)),(0,n.Lk)("p",V,(0,l.v_)(r.area.aforo.amount),1)])]),(0,n.Lk)("div",P,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>r.searchQuery=e),type:"text",placeholder:"Buscar por nombre o identificador",class:"w-full p-2 rounded-lg border border-[#1cb0c8] focus:outline-none"},null,512),[[a.Jo,r.searchQuery]])]),r.area?((0,n.uX)(),(0,n.CE)("div",q,[(0,n.Lk)("div",null,[(0,n.Lk)("div",z,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(r.filteredGroupedItems,((e,o)=>((0,n.uX)(),(0,n.CE)("div",{key:o,class:"bg-gray-100 p-4 rounded-lg shadow-md border border-gray-200"},[(0,n.Lk)("p",U,(0,l.v_)(e[0].typeName)+" ("+(0,l.v_)(e.length)+" etiquetas) ",1),(0,n.Lk)("div",D,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(r.filteredVisibleItems[o],((e,o)=>((0,n.uX)(),(0,n.CE)("div",{key:o,class:"p-1 rounded-sm"},[(0,n.Lk)("p",G,[t[6]||(t[6]=(0,n.Lk)("strong",null,"◉",-1)),(0,n.eW)(" "+(0,l.v_)(e.name)+" ("+(0,l.v_)(e.identifier)+")",1)])])))),128))]),e.length>r.filteredVisibleItems[o].length?((0,n.uX)(),(0,n.CE)("div",J,[(0,n.Lk)("button",{class:"text-[#1cb0c8] hover:text-[#1c9ccc] text-sm font-semibold",onClick:e=>r.showMore(o)},t[7]||(t[7]=[(0,n.eW)(" Ver más "),(0,n.Lk)("span",null,"▼",-1)]),8,Y)])):r.filteredVisibleItems[o].length>6?((0,n.uX)(),(0,n.CE)("div",Z,[(0,n.Lk)("button",{class:"text-[#1cb0c8] hover:text-[#1c9ccc] text-sm font-semibold",onClick:e=>r.showLess(o)},t[8]||(t[8]=[(0,n.eW)(" Ver menos "),(0,n.Lk)("span",null,"▲",-1)]),8,ee)])):(0,n.Q3)("",!0)])))),128))])])])):((0,n.uX)(),(0,n.CE)("div",te,t[9]||(t[9]=[(0,n.Lk)("p",null,"No se seleccionó ningún área.",-1)])))])):(0,n.Q3)("",!0)])),_:1})}o(4114);var ne={setup(){const e=(0,b.KR)(!1),t=(0,b.KR)(null),o=(0,b.KR)(""),a=(0,b.Kh)({}),l=(0,b.Kh)({}),r=(0,n.EW)((()=>t.value?.items?t.value.items.reduce(((e,t)=>(e[t.typeId]||(e[t.typeId]=[]),e[t.typeId].push(t),e)),{}):{})),i=(0,n.EW)((()=>{if(!o.value)return r.value;const e=o.value.toLowerCase(),t={};for(const[o,n]of Object.entries(r.value)){const a=n.filter((t=>t.name.toLowerCase().includes(e)||t.identifier.toLowerCase().includes(e)));a.length&&(t[o]=a)}return t})),s=()=>{for(const e of Object.keys(r.value))a[e]=r.value[e].slice(0,6)},c=()=>{for(const[e,t]of Object.entries(i.value))l[e]=t.slice(0,6)},u=e=>{const t=l[e].length;l[e]=i.value[e].slice(0,t+6)},d=e=>{l[e]=i.value[e].slice(0,6)},g=o=>{console.log("Evento recibido:",o),t.value=o,s(),c(),e.value=!0},f=()=>{e.value=!1,t.value=null};return(0,n.wB)(i,c),(0,n.sV)((()=>{F.B.on("area-clicked",g)})),(0,n.xo)((()=>{F.B.off("area-clicked",g)})),{isOpen:e,area:t,searchQuery:o,groupedItems:r,filteredGroupedItems:i,visibleItems:a,filteredVisibleItems:l,showMore:u,showLess:d,openPanel:g,closePanel:f}}};const ae=(0,R.A)(ne,[["render",oe],["__scopeId","data-v-17d0a0bf"]]);var le=ae,re={components:{MonitoringBeacon:O,MonitoringLayout:le},props:{name:{type:String,required:!0},backgroundimage:{type:String,required:!0},areas:{type:Array,required:!0},highlightedBeacon:{type:String,default:null}},emits:["highlight","beacon-group-count"],setup(e,{emit:t}){const o={width:1300,height:570},a=(0,b.KR)(null),l=(0,b.KR)(null),r=e=>e.color?`${e.color}50`:"rgba(173, 216, 230, 0.3)",i=e=>{const t=e.length,o=e.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e)),{x:0,y:0});return{x:o.x/t,y:o.y/t}},s=e=>{if(!e||"string"!==typeof e)return console.warn("Coordenadas inválidas:",e),[];const t=e.split(")").map((e=>e.trim())).filter((e=>e.length>0)).map((e=>{const t=e.replace("(","").trim(),[o,n]=t.split(",").map((e=>parseFloat(e.trim())));return{x:o,y:n}}));return t},c=()=>{if(e.backgroundimage){const t=new Image;t.src=e.backgroundimage,t.onload=()=>{a.value=t}}},u=e=>{console.log("Área seleccionada:",e),F.B.emit("area-clicked",e)},d=(e,t,o)=>{const n=s(t.coordinates),a=Math.min(...n.map((e=>e.x))),l=Math.max(...n.map((e=>e.x))),r=Math.min(...n.map((e=>e.y))),i=Math.max(...n.map((e=>e.y))),c=l-a,u=i-r,d=t.items.length,g=Math.ceil(Math.sqrt(d)),f=Math.ceil(d/g),h=c/g,p=u/f,m=Math.floor(o/g),v=o%g;return{x:a+v*h+h/2,y:r+m*p+p/2}},g=e=>{const t=e.target.getStage().container();t.style.cursor="pointer"},f=e=>{const t=e.target.getStage().container();t.style.cursor="default"},h=e=>{const o=e.reduce(((e,t)=>(e[t.typeId]?e[t.typeId].count++:e[t.typeId]={beacon:t,count:1},e)),{}),n=Object.entries(o).map((([e,o])=>(t("beacon-group-count",{typeId:e,count:o.count,beacon:o.beacon}),{...o.beacon,groupCount:o.count})));return n},p=(e,t)=>e.filter((e=>t.includes(e.typeId))),m=(e,t)=>e.filter((e=>t.includes(e.typeId))).length,v=t=>{let o=[];for(const n of e.areas)o=o.concat(n.items.filter((e=>e.typeId===t)));return o},y=t=>{for(const o of e.areas){const e=o.items.find((e=>e._id===t));if(e)return{beacon:e,area:o}}return null};(0,n.sV)(c),(0,n.wB)((()=>e.backgroundimage),c),(0,n.wB)((()=>e.highlightedBeacon),(e=>{if(console.log("Nuevo valor recibido en highlightedBeacon (hijo):",e),e){const t=k(e);t?console.log("Beacon encontrado (hijo):",t):console.warn("No se encontró el beacon con el ID (hijo):",e)}else console.log("No hay beacon seleccionado (hijo).")}));const k=t=>{for(const o of e.areas){const e=o.items.find((e=>e._id===t));if(e)return e}return null},x=e=>{console.log(`Highlighting beacon with ID: ${e}`),l.value=e,setTimeout((()=>l.value=null),3e3)};return(0,n.wB)((()=>e.highlightedBeacon),(e=>{console.log("Nuevo beacon destacado:",y(e))})),{stageConfig:o,backgroundImg:a,parseCoordinates:s,calculateAreaCenter:i,onAreaNameClick:u,getBeaconPosition:d,onTextHover:g,onTextOut:f,filterBeaconsForAforo:p,reduceBeaconsByTypeId:h,highlightBeacon:x,countBeaconsForAforo:m,findBeaconById:k,findBeaconsByTypeId:v,findBeaconAndAreaById:y,getAreaColor:r}}};const ie=(0,R.A)(re,[["render",X]]);var se=ie,ce=o(5129),ue={components:{ModalLayoutPlane:se},setup(){const e=(0,b.KR)([]),t=(0,b.KR)(0),o=(0,b.KR)(""),a=(0,b.KR)([]),l=(0,b.KR)(null),r=ce.A.state.token,i=ce.A.state.customerid,s=e=>{l.value=e,setTimeout((()=>{l.value=null}),1e4)},c=async()=>{try{const t=await C(r);e.value=t.data.data.map((e=>({...e,areas:e.areas.map((t=>({...t,items:t.items.map((o=>({...o,areaName:t.name,layoutId:e._id})))})))}))),I(u,d,i)}catch(t){console.error("Error al cargar los datos:",t)}},u=t=>{e.value=t},d=e=>{console.error("Error en la conexión de Socket.IO:",e)},g=()=>{if(!o.value.trim())return void(a.value=[]);const t=o.value.toLowerCase(),n=e.value.flatMap((e=>e.areas.flatMap((t=>t.items.map((o=>({...o,areaName:t.name,layoutId:e._id})))))));a.value=n.filter((e=>e.name.toLowerCase().includes(t)||e.identifier&&e.identifier.toLowerCase().includes(t))).map((e=>({id:e._id,name:e.name,identifier:e.identifier||"N/A",areaName:e.areaName,layoutId:e.layoutId})))},f=n=>{const l=e.value.flatMap((e=>e.areas.flatMap((e=>e.items)))).find((e=>e._id===n));if(l){const o=e.value.findIndex((e=>e._id===l.layoutId));-1!==o&&(t.value=o),s(l._id)}o.value="",a.value=[]},h=(0,n.EW)((()=>e.value[t.value])),p=e=>{t.value=e};return(0,n.sV)(c),(0,n.hi)((()=>{B()})),{layouts:e,selectedLayout:h,selectedIndex:t,selectLayout:p,searchQuery:o,searchResults:a,updateSearchResults:g,selectBeaconFromSearch:f,highlightBeacon:s,highlightedBeacon:l}}};const de=(0,R.A)(ue,[["render",y],["__scopeId","data-v-d5ab9a14"]]);var ge=de}}]);
//# sourceMappingURL=643.3684eb00.js.map